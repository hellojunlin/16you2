//支付
function pay(gid,data){
	$.ajax({
		type:'post',
		dataType:'json',
		data:{
			gid:gid,
			out_trade_no: data.out_trade_no, //'厂商订单编号',
			product_id: data.product_id, //'商品id',
			total_fee: data.total_fee,//'支付总金额	以分为单位 必须大于0',
			body: data.body, //订单或商品的名称',
			detail: data.detail, //订单或商品的详情',
			attach: data.attach, //	后台通知时原样返回
			sign: data.sign, //'请求参数签名'
			},
		url:'/pay/getdata.html',
		success:function(data){
			var param = {};
			if(data.errorcode==0){//显示微信支付二维码
				$("#paycode").show().find('img').attr('src',data.codeurl);
				setpay = setInterval(function(){
					$.ajax({//检测是否已经付款
						url:'/start/detection.html',
						type:'post',
						dataType:'json',
						data:{'transaction_id':data.tid},
						success:function(sres){
							if(sres.errorcode==0){
								console.log("aaaaaaaaaaaaaaaaa");
								alert("付款成功");
								$("#paycode").hide().find('img').attr('src','/media/images/codejiazai.gif');
								clearInterval(setpay);
							}else{
								console.log(sres.info);
							}
						}
					});
				}, 3000);    
			}else if(data.errorcode=='OUT_TRADE_NO_USED'){	//订单号重复
				param.type="payresult";
				param.msg="error";
				window.frames[0].postMessage(param,gameurl);
			}else{
				param.type="payresult";
				param.msg="error";
				window.frames[0].postMessage(param,gameurl);
			}
		}
	})
}
//父窗口监听事件
function parentlistener(param){
	window.addEventListener('message',function(e){
		var data=e.data; 
		if(typeof(data)=='string'){//字符串转json对象
			data = JSON.parse(data);
		}
		if(data.type=="pay" && typeof(param.gid)!='undefined'){//请求支付
			$("#div_pay_code").show();
			pay(param.gid,data);
		}
	},false);  
}