/*
 * 调起支付方式页面
 */
var s_data = '';
var s_gid = '';
function selectpay(gid,data){
	$('.paynum').text(data.total_fee/100);
	s_gid = gid;
	s_data = data;
	$('.rechangemodal').show();
}

//支付
function pay(gid,data){
	$.ajax({
		type:'post',
		dataType:'json',
		data:{
			gid:gid,
			out_trade_no: data.out_trade_no, //'厂商订单编号',
			product_id: data.product_id, //'商品id',
			total_fee: data.total_fee,//'支付总金额	以分为单位 必须大于0',
			body: data.body, //订单或商品的名称',
			detail: data.detail, //订单或商品的详情',
			attach: data.attach, //	后台通知时原样返回
			sign: data.sign, //'请求参数签名'
			},
		url:'/pay/getdata.html',
		success:function(data){
			$('.loadbox').hide();
			$('.rechangemodal').hide();
			var param = {};
			if(data.errorcode==0){//显示微信支付二维码
				$("#paycode").show().find('img').attr('src',data.codeurl);
				setpay = setInterval(function(){
					$.ajax({//检测是否已经付款
						url:'/start/detection.html',
						type:'post',
						dataType:'json',
						data:{'transaction_id':data.tid},
						success:function(sres){
							if(sres.errorcode==0){
								console.log("aaaaaaaaaaaaaaaaa");
								alert("付款成功");
								$("#paycode").hide().find('img').attr('src','/media/images/codejiazai.gif');
								clearInterval(setpay);
							}else{
								console.log(sres.info);
							}
						}
					});
				}, 3000);    
			}else if(data.errorcode=='OUT_TRADE_NO_USED'){	//订单号重复
				param.type="payresult";
				param.msg="error";
				window.frames[0].postMessage(param,gameurl);
			}else{
				param.type="payresult";
				param.msg="error";
				window.frames[0].postMessage(param,gameurl);
			}
		}
	})
}
//父窗口监听事件
function parentlistener(param) {
	window.addEventListener('message', function(e) {
		var data = e.data;
		if (typeof(data) == 'string') {
			data = JSON.parse(data)
		}
		if (data.type == "pay" && typeof(param.gid) != 'undefined') {
			selectpay(param.gid, data)
		} else if (data.type == "share") {
			type =1;
			//var checkdata = checkparam(data);
			//getdata(checkdata)
		} else if (data.type == "parentshare") {
			//var checkdata = checkparam(param.gameshare);
			//getdata(checkdata)
		}else if(data.type=="subecribe") {//关注
	    	getsubecribe(data);
	    }else if(data.type=="showQRCode"){
	    	$('#wxmodal').css('display','block');
	    } 
		/*else if (typeof(data.type) == 'undefined' && shareboolean == true) {
			shareboolean = false;
			var checkdata = checkparam(param.gameshare);
			getdata(checkdata)
		}*/
	}, false)
}

//关注
function getsubecribe(param){
//	var locaturl = window.location.href;
	$.ajax({		//异步提交数据
		type:'get',
		dataType:'JSONP',
		url:'http://gameapi.16you.com/userinfo/checksubscribe.html?partnerid='+param.partnerid+'&access_token='+param.access_token+'&sign='+param.sign,
		jsonp: "jsoncallback",
		success:function(data){
			if(data.code=="1"){//已关注
				param.type="subecribe";
				param.msg="success";
				window.frames[0].postMessage(param,gameurl);
			}else if(data.code=="0"){//未关注
				param.type="subecribe";
				param.msg="faile";
				window.frames[0].postMessage(param,gameurl);
			}
		}
	});
}