/*
 * 调起支付方式页面
 */
var s_data = '';
var s_gid = '';
function selectpay(gid,data){
	$('.paynum').text(data.total_fee/100);
	s_gid = gid;
	s_data = data;
	$('.rechangemodal').show();
}

function getdata(param) {
			wx.ready(function() {
				if (typeof(param.friend) != 'undefined') {
					wx.onMenuShareAppMessage(param.friend);
				}
				if (typeof(param.timeline != 'undefined')) {
					wx.onMenuShareTimeline(param.timeline);
				}
				wx.hideMenuItems({
					menuList: ['menuItem:share:qq', "menuItem:share:QZone", 'menuItem:openWithQQBrowser', "menuItem:openWithSafari"]
				})
			})
}
var type = 2;
function checkparam(param) {
	var data = {};
	data.wx = ['hideMenuItems'];
	if (typeof(param) == 'object') {
		$(param).each(function(k, v) {
			if (typeof(v.share) != 'undefined') {
				$(v.share).each(function(key, value) {
					if (typeof(value.friend) != 'undefined') {
						var friendshare = {
							title: value.friend.title,
							desc: value.friend.desc,
							link: value.friend.link,
							imgUrl: value.friend.imgUrl,
							type: 'link',
							success: function() {
								param.type = "shareresult";
								param.msg = "success";
								if (type == 1) {
									window.frames[0].postMessage(param,'*')
								}
							},
							cancel: function() {
								param.type = "shareresult";
								param.msg = "cancel";
								if (type == 1) {
									window.frames[0].postMessage(param, '*')
								}
							}
						};
						data.friend = friendshare;
						data.wx.push('onMenuShareTimeline')
					}
					if (typeof(value.timeline) != 'undefined') {
						var timelineshare = {
							title: value.timeline.title,
							link: value.timeline.link,
							imgUrl: value.timeline.imgUrl,
							success: function() {
								param.type = "timelineresult";
								param.msg = "success";
								if (type == 1) {
									window.frames[0].postMessage(param, '*')
								}
							},
							cancel: function() {
								param.type = "timelineresult";
								param.msg = "cancel";
								if (type == 1) {
									window.frames[0].postMessage(param, '*') 
								}
							}
						};
						data.timeline = timelineshare;
						data.wx.push('onMenuShareAppMessage')
					}
				})
			}
		})
	}
	return data
}
var jsApiParameters;

function pay(gid, data) {
	$.ajax({
		type: 'post',
		dataType: 'json',
		data: {
			gid: gid,
			out_trade_no: data.out_trade_no,
			product_id: data.product_id,
			total_fee: data.total_fee,
			body: data.body,
			detail: data.detail,
			attach: data.attach,
			sign: data.sign,
		},
		url: '/pay/getdata.html',
		success: function(data) {
			$('.loadbox').hide();
			$('.rechangemodal').hide();
			var param = {};
			if (data.errorcode == 0) {
				jsApiParameters = data.jsApiParameters;
				callpay()
			} else if (data.errorcode == 'OUT_TRADE_NO_USED') {
				param.type = "payresult";
				param.msg = "error";
				window.frames[0].postMessage(param, '*')
			} else {
				param.type = "payresult";
				param.msg = "error";
				window.frames[0].postMessage(param, '*');
			}
		}
	})
}

function jsApiCall() {
	WeixinJSBridge.invoke('getBrandWCPayRequest', {
		"appId": jsApiParameters.appId,
		"timeStamp": jsApiParameters.timeStamp,
		"nonceStr": jsApiParameters.nonceStr,
		"package": jsApiParameters.package,
		"signType": "MD5",
		"paySign": jsApiParameters.paySign
	}, function(res) {
		var param = {};
		if (res.err_msg == "get_brand_wcpay_request:ok") {
			param.type = "payresult";
			param.msg = "success";
			window.frames[0].postMessage(param, '*')
		} else if (res.err_msg = "get_brand_wcpay_request:cancel") {
			param.type = "payresult";
			param.msg = "error";
			window.frames[0].postMessage(param, '*')
		}else{
			param.type = "payresult";
			param.msg = "fail";
			window.frames[0].postMessage(param, '*')
		}
	})
}

function callpay() {
	if (typeof WeixinJSBridge == "undefined") {
		if (document.addEventListener) {
			document.addEventListener('WeixinJSBridgeReady', jsApiCall, false)
		} else if (document.attachEvent) {
			document.attachEvent('WeixinJSBridgeReady', jsApiCall);
			document.attachEvent('onWeixinJSBridgeReady', jsApiCall)
		}
	} else {
		jsApiCall()
	}
}


//关注
function getsubecribe(param){
//	var locaturl = window.location.href;
	$.ajax({		//异步提交数据
		type:'get',
		dataType:'JSONP',
		url:'http://gameapi.16you.com/userinfo/checksubscribe.html?partnerid='+param.partnerid+'&access_token='+param.access_token+'&sign='+param.sign,
		jsonp: "jsoncallback",
		success:function(data){
			console.log(gameurl);
			if(data.code=="1"){//已关注
				param.type="subecribe";
				param.msg="success";
				window.frames[0].postMessage(param,'*');
			}else if(data.code=="0"){//未关注
				param.type="subecribe";
				param.msg="faile";
				window.frames[0].postMessage(param,'*');
			}
		}
	});
}

function sendmsgtoiframe(param, gameurl) {
	window.frames[0].postMessage(param, '*')
}
var shareboolean = true;
function parentlistener(param) {
	window.addEventListener('message', function(e) {
		var data = e.data;
		if (typeof(data) == 'string') {
			data = JSON.parse(data)
		}
		console.log(data.type);
		if (data.type == "pay" && typeof(param.gid) != 'undefined') {
			selectpay(param.gid, data)
		} else if (data.type == "share") {
			type =1;
			var checkdata = checkparam(data);
			getdata(checkdata)
		} else if (data.type == "parentshare") {
			var checkdata = checkparam(param.gameshare);
			getdata(checkdata)
		}else if(data.type=="subecribe") {//关注
	    	getsubecribe(data);
	    }else if(data.type=="showQRCode"){
	    	$('#wxmodal').css('display','block');
	    } 
		/*else if (typeof(data.type) == 'undefined' && shareboolean == true) {
			shareboolean = false;
			var checkdata = checkparam(param.gameshare);
			getdata(checkdata)
		}*/
	}, false)
}